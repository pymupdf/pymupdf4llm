# Configuration for the Makefile

# We use $OS from environment if set.
ifeq ($(OS),)
  OS := $(shell uname)
  OS := $(OS:MINGW%=MINGW)
  OS := $(OS:MSYS%=MINGW)
  OS := $(OS:Windows_NT=MINGW)
  OS := $(OS:Darwin=MACOS)
endif

WARNING_CFLAGS := -Wall -Wsign-compare

# Feature configuration options

build_suffix :=

# System specific features

ifeq ($(findstring -fembed-bitcode,$(XCFLAGS)),)
  # clang does not support these in combination with -fembed-bitcode
  CFLAGS += -ffunction-sections -fdata-sections
endif

ifeq ($(OS),MACOS)
  LDREMOVEUNREACH := -Wl,-dead_strip
  SO := dylib
else
  LDREMOVEUNREACH := -Wl,--gc-sections
  ifeq ($(OS),MINGW)
    SO := dll
    EXE := .exe
  else
    SO := so
  endif
endif

ifeq "$(OS)" "ios"
  NEONFLAGS =
else
  NEONFLAGS = -mneon
endif

SANITIZE_FLAGS += -fsanitize=address
SANITIZE_FLAGS += -fsanitize=leak

ifeq ($(shared),yes)
  ifeq ($(findstring shared-, $(build_prefix)),)
    override build_prefix := $(build_prefix)shared-
  endif
  LIB_CFLAGS = -fPIC
  ifeq ($(OS),MACOS)
    LIB_LDFLAGS = -dynamiclib
  else ifeq ($(OS),wasm)
    LIB_LDFLAGS = -shared -sSIDE_MODULE
    EXE_LDFLAGS = -sMAIN_MODULE
  else ifeq ($(OS),wasm-mt)
    LIB_LDFLAGS = -shared -sSIDE_MODULE
    EXE_LDFLAGS = -sMAIN_MODULE
  else ifeq ($(OS),pyodide)
    LIB_LDFLAGS = -shared -sSIDE_MODULE
    EXE_LDFLAGS = -sMAIN_MODULE

    # Pyodide's ld does not support -b so we cannot use it to create object
    # files containing font data, so leave HAVE_OBJCOPY unset. And we need
    # extra memory when linking.
    LDFLAGS += -sTOTAL_MEMORY=48MB
  else
    LIB_LDFLAGS = -shared
  endif
else
  LIB_CFLAGS =
  LIB_LDFLAGS =
endif

ifeq ($(build),debug)
  CFLAGS += -pipe -g
  LDFLAGS += -g
else ifeq ($(build),release)
  CFLAGS += -pipe -O2 -DNDEBUG
  LDFLAGS += $(LDREMOVEUNREACH) -Wl,-s
else ifeq ($(build),small)
  CFLAGS += -pipe -Os -DNDEBUG
  LDFLAGS += $(LDREMOVEUNREACH) -Wl,-s
else ifeq ($(build),valgrind)
  CFLAGS += -pipe -O2 -DNDEBUG -DPACIFY_VALGRIND
  LDFLAGS += $(LDREMOVEUNREACH) -Wl,-s
else ifeq ($(build),sanitize)
  CFLAGS += -pipe -g $(SANITIZE_FLAGS)
  LDFLAGS += -g $(SANITIZE_FLAGS)
else ifeq ($(build),sanitize-release)
  CFLAGS += -pipe -O2 -DNDEBUG $(SANITIZE_FLAGS)
  LDFLAGS += $(LDREMOVEUNREACH) -Wl,-s $(SANITIZE_FLAGS)
else ifeq ($(build),profile)
  CFLAGS += -pipe -O2 -DNDEBUG -pg
  LDFLAGS += -pg
else ifeq ($(build),coverage)
  CFLAGS += -pipe -g -pg -fprofile-arcs -ftest-coverage
  LIBS += -lgcov
else ifeq ($(build),native)
  CFLAGS += -pipe -O2 -DNDEBUG -march=native
  LDFLAGS += $(LDREMOVEUNREACH) -Wl,-s
else ifeq ($(build),memento)
  CFLAGS += -pipe -g -DMEMENTO -DMEMENTO_MUPDF_HACKS
  LDFLAGS += -g -rdynamic
  ifneq ($(HAVE_LIBDL),no)
    CFLAGS += -DHAVE_LIBDL
    ifeq ($(OS),OpenBSD)
      LIBS += -L /usr/local/lib -l execinfo
    else
      LIBS += -ldl
    endif
  endif
else ifeq ($(build),gperf)
  CFLAGS += -pipe -O2 -DNDEBUG -DGPERF
  LIBS += -lprofiler
else
  $(error unknown build setting: '$(build)')
endif

ifeq ($(OS),OpenBSD)
  LDFLAGS += -pthread
endif

ifeq ($(OS),Linux)
    LINUX_OR_OPENBSD := yes
endif
ifeq ($(OS),OpenBSD)
    LINUX_OR_OPENBSD := yes
endif

ifeq ($(OS),MINGW)
  WINDRES := windres
  HAVE_WIN32 := yes

else ifeq ($(OS),MACOS)
  HAVE_GLUT := yes
  SYS_GLUT_CFLAGS := -Wno-deprecated-declarations
  SYS_GLUT_LIBS := -framework GLUT -framework OpenGL
  CC = xcrun cc
  AR = xcrun ar
  LD = xcrun ld
  RANLIB = xcrun ranlib
endif

